#!/bin/bash
# COMMIT-MSG HOOK — Enforces commit message discipline + scaffold boundary
# Runs automatically after writing commit message, before commit finalizes.

MSG=$(head -1 "$1")
BLOCKED=0

# ============================================
# CHECK 1: Feature batching detection
# ============================================
MSG_LEN=${#MSG}
if [ "$MSG_LEN" -gt 72 ]; then
    echo "⛔ BLOCKED: Commit message is $MSG_LEN chars (max 72). You're likely batching features."
    echo "   Split into separate commits, each describing ONE thing in 3-7 words."
    BLOCKED=1
fi

if echo "$MSG" | grep -qiE '\band\b.*\band\b'; then
    echo "⛔ BLOCKED: Message contains multiple 'and's — this is feature batching."
    BLOCKED=1
fi

COMMA_COUNT=$(echo "$MSG" | tr -cd ',' | wc -c)
if [ "$COMMA_COUNT" -ge 2 ]; then
    echo "⛔ BLOCKED: Message has $COMMA_COUNT commas — looks like a feature list. One feature per commit."
    BLOCKED=1
fi

if echo "$MSG" | grep -qiE '(comprehensive|various|multiple improvements|several fixes)'; then
    echo "⛔ BLOCKED: Words like 'comprehensive/various/multiple' signal batching. One feature per commit."
    BLOCKED=1
fi

# ============================================
# CHECK 2: Fix spiral hard stop
# ============================================
if echo "$MSG" | grep -q "^fix:"; then
    FIX_COUNT=$(git log --oneline -15 2>/dev/null | grep -c "fix:" 2>/dev/null || true)
    FIX_COUNT=${FIX_COUNT:-0}

    if [ "$FIX_COUNT" -ge 4 ]; then
        echo ""
        echo "⛔ BLOCKED: This would be fix commit #$((FIX_COUNT + 1)) in recent history."
        echo "   You are in a fix spiral. REQUIRED: Disable the broken feature."
        echo "   Log the issue in BUGS.md. Move to the next task."
        echo ""
        BLOCKED=1
    elif [ "$FIX_COUNT" -ge 2 ]; then
        echo ""
        echo "⚠️  WARNING: This is fix commit #$((FIX_COUNT + 1)) in this area."
        echo "   At fix #5, this commit will be BLOCKED."
        echo ""
    fi
fi

# ============================================
# CHECK 3: Require prefix
# ============================================
if ! echo "$MSG" | grep -qE '^(feat|fix|refactor|style|docs|chore|perf|test|scaffold):'; then
    echo "⛔ BLOCKED: Commit message must start with a prefix (feat:, fix:, scaffold:, docs:, etc.)"
    BLOCKED=1
fi

# ============================================
# CHECK 4: PROGRESS.md enforcement on feat: commits
# ============================================
if echo "$MSG" | grep -q "^feat:"; then
    FEAT_COUNT=$(git log --oneline -30 2>/dev/null | grep -c "^[a-f0-9]* feat:" 2>/dev/null || true)
    FEAT_COUNT=${FEAT_COUNT:-0}
    NEXT_FEAT=$((FEAT_COUNT + 1))

    if [ "$NEXT_FEAT" -ge 4 ] && [ ! -f "PROGRESS.md" ]; then
        echo ""
        echo "⛔ BLOCKED: This is feature #$NEXT_FEAT but PROGRESS.md does not exist."
        echo "   HARD STOP 6: PROGRESS.md is MANDATORY after feature #3."
        echo "   Create PROGRESS.md first (docs: add progress checkpoint), then retry."
        echo ""
        BLOCKED=1
    elif [ "$NEXT_FEAT" -eq 3 ]; then
        echo ""
        echo "⚠️  REMINDER: This is feature #3. After committing, create PROGRESS.md (HARD STOP 6)."
        echo "   Your NEXT feat: commit will be BLOCKED without it."
        echo ""
    fi
fi

# ============================================
# CHECK 5: TESTED.md enforcement on feat: commits
# ============================================
# At feature #4+, TESTED.md MUST exist
if echo "$MSG" | grep -q "^feat:"; then
    FEAT_COUNT=$(git log --oneline -30 2>/dev/null | grep -c "^[a-f0-9]* feat:" 2>/dev/null || true)
    FEAT_COUNT=${FEAT_COUNT:-0}
    NEXT_FEAT=$((FEAT_COUNT + 1))

    if [ "$NEXT_FEAT" -ge 4 ] && [ ! -f "TESTED.md" ]; then
        echo ""
        echo "⛔ BLOCKED: This is feature #$NEXT_FEAT but TESTED.md does not exist."
        echo "   HARD STOP 5: Run Playwright tests and write results to TESTED.md."
        echo "   Create TESTED.md first (docs: add test results), then retry."
        echo ""
        BLOCKED=1
    elif [ "$NEXT_FEAT" -eq 3 ]; then
        echo ""
        echo "⚠️  REMINDER: This is feature #3. Create TESTED.md with Playwright test results."
        echo "   Your NEXT feat: commit will be BLOCKED without it."
        echo ""
    fi
fi

# ============================================
# CHECK 6: Scaffold boundary enforcement
# ============================================
# scaffold: commits may ONLY contain config/boilerplate files.
# Any project-specific .tsx (hero, landing, custom pages) = must be feat: commit.
if echo "$MSG" | grep -q "^scaffold:"; then
    SCAFFOLD_VIOLATION=0

    for file in $(git diff --cached --name-only); do
        # Allow: package.json, tsconfig, config files, .gitignore, README
        if echo "$file" | grep -qE '(package\.json|package-lock\.json|tsconfig|next\.config|tailwind\.config|postcss\.config|\.gitignore|\.eslintrc|eslint\.config|README)'; then
            continue
        fi

        # Allow: globals.css, lib/utils.ts
        if echo "$file" | grep -qE '(globals\.css|lib/utils\.ts|lib/utils\.js)'; then
            continue
        fi

        # Allow: shadcn components in components/ui/
        if echo "$file" | grep -qE 'components/ui/'; then
            continue
        fi

        # Allow: default Next.js boilerplate files
        if echo "$file" | grep -qE '(layout\.(tsx|ts|js)|page\.(tsx|ts|js)|error\.(tsx|ts|js)|not-found\.(tsx|ts|js)|loading\.(tsx|ts|js))$'; then
            continue
        fi

        # Allow: public/ assets (favicon, icons)
        if echo "$file" | grep -qE '^public/'; then
            continue
        fi

        # Allow: non-code files (md, json at root, env.example)
        if echo "$file" | grep -qE '\.(md|json|mjs|cjs)$'; then
            continue
        fi

        # Allow: convex config files
        if echo "$file" | grep -qE '^convex/'; then
            continue
        fi

        # BLOCK: Any .tsx/.ts/.jsx/.js that isn't in the allowed list above
        if echo "$file" | grep -qE '\.(tsx|ts|jsx|js)$'; then
            echo "⛔ SCAFFOLD VIOLATION: $file is a project-specific file."
            echo "   scaffold: commits may only contain config/boilerplate."
            echo "   Move this to a separate feat: commit."
            SCAFFOLD_VIOLATION=1
        fi
    done

    if [ "$SCAFFOLD_VIOLATION" -eq 1 ]; then
        echo ""
        echo "⛔ BLOCKED: scaffold: commit contains project-specific files."
        echo "   Allowed in scaffold: package.json, tsconfig, config files, globals.css,"
        echo "   lib/utils.ts, components/ui/*, layout.tsx, page.tsx (default template),"
        echo "   error.tsx, not-found.tsx, loading.tsx, public/, convex/."
        echo ""
        echo "   Everything else must be a separate feat: commit."
        echo ""
        BLOCKED=1
    fi
fi

if [ "$BLOCKED" -eq 1 ]; then
    echo ""
    echo "Commit blocked. Fix the issue and try again."
    exit 1
fi

exit 0
