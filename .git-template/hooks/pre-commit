#!/bin/bash
# PRE-COMMIT HOOK — Mechanical enforcement of build rules
# Runs automatically before every commit. Agent cannot bypass this.

BLOCKED=0

# ============================================
# CHECK 1: File size limit (max 300 lines)
# ============================================
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx?|jsx?|ts|js)$'); do
    if [ -f "$file" ]; then
        lines=$(wc -l < "$file")
        if [ "$lines" -gt 300 ]; then
            echo "⛔ BLOCKED: $file has $lines lines (max 300). Split it before committing."
            BLOCKED=1
        fi
    fi
done

# ============================================
# CHECK 2: Fix spiral detection
# ============================================
FIX_COUNT=$(git log --oneline -20 2>/dev/null | grep -c "fix:" 2>/dev/null || true)
FIX_COUNT=${FIX_COUNT:-0}
if [ "$FIX_COUNT" -ge 4 ]; then
    echo ""
    echo "⚠️  WARNING: $FIX_COUNT fix commits in last 20. You may be spiraling."
    echo "   Consider: disable the broken feature, log in BUGS.md, move on."
    echo ""
fi

# ============================================
# CHECK 3: TESTED.md artifact enforcement
# ============================================
FEAT_COUNT=$(git log --oneline -30 2>/dev/null | grep -c "^[a-f0-9]* feat:" 2>/dev/null || true)
FEAT_COUNT=${FEAT_COUNT:-0}

if [ "$FEAT_COUNT" -ge 3 ]; then
    if [ ! -f "TESTED.md" ]; then
        echo ""
        echo "⛔ BLOCKED: $FEAT_COUNT features committed but TESTED.md does not exist."
        echo "   HARD STOP 5 requires Playwright testing after each feature."
        echo "   Create TESTED.md with test results before committing more features."
        echo ""
        BLOCKED=1
    fi
fi

# ============================================
# CHECK 4: PROGRESS.md checkpoint enforcement
# ============================================
if [ "$FEAT_COUNT" -ge 3 ]; then
    if [ ! -f "PROGRESS.md" ]; then
        echo ""
        echo "⛔ BLOCKED: $FEAT_COUNT features committed but PROGRESS.md does not exist."
        echo "   HARD STOP 6: PROGRESS.md is MANDATORY after feature #3."
        echo "   Run git log, count features, write PROGRESS.md, commit it first."
        echo ""
        BLOCKED=1
    fi
fi

# ============================================
# CHECK 5: No secrets in committed files
# ============================================
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ]; then
        if grep -qE '(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36})' "$file" 2>/dev/null; then
            echo "⛔ BLOCKED: $file appears to contain an API key or secret. Remove it before committing."
            BLOCKED=1
        fi
    fi
done

# ============================================
# CHECK 6: No .env files committed
# ============================================
for file in $(git diff --cached --name-only); do
    if echo "$file" | grep -qE '\.env(\.local|\.production)?$'; then
        echo "⛔ BLOCKED: $file is an environment file. Add it to .gitignore."
        BLOCKED=1
    fi
done

if [ "$BLOCKED" -eq 1 ]; then
    echo ""
    echo "Commit blocked. Fix the issues above and try again."
    exit 1
fi

exit 0
