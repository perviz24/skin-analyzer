#!/bin/bash
# PRE-COMMIT HOOK — Mechanical enforcement of build rules
# Runs automatically before every commit. Agent cannot bypass this.
# Install: git config core.hooksPath .githooks

BLOCKED=0

# ============================================
# CHECK 1: File size limit (max 300 lines)
# ============================================
# TentaGen lesson: 11 files exceeded 300 lines, worst at 1,735
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx?|jsx?|ts|js)$'); do
    if [ -f "$file" ]; then
        lines=$(wc -l < "$file")
        if [ "$lines" -gt 300 ]; then
            echo "⛔ BLOCKED: $file has $lines lines (max 300). Split it before committing."
            BLOCKED=1
        fi
    fi
done

# ============================================
# CHECK 2: Fix spiral detection (max 3 fixes on same area)
# ============================================
# TentaGen lesson: PDF had 10 fix commits, video had 12, export had 15+
# Check if this is a fix commit by looking at the staged commit message
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
    MSG=$(head -1 "$COMMIT_MSG_FILE")
else
    # For commits with -m flag, we check in commit-msg hook instead
    MSG=""
fi

# Count recent fix commits (last 20)
FIX_COUNT=$(git log --oneline -20 2>/dev/null | grep -c "fix:" 2>/dev/null || true)
FIX_COUNT=${FIX_COUNT:-0}
if [ "$FIX_COUNT" -ge 4 ]; then
    echo ""
    echo "⚠️  WARNING: $FIX_COUNT fix commits in last 20. You may be spiraling."
    echo "   Consider: disable the broken feature, log in BUGS.md, move on."
    echo ""
    # Warning only at 4, not blocking — the commit-msg hook handles the hard block
fi

# ============================================
# CHECK 3: TESTED.md artifact enforcement
# ============================================
# After 3+ feat: commits, warn if no TESTED.md
# After 5+ feat: commits, BLOCK if no TESTED.md
FEAT_COUNT=$(git log --oneline -30 2>/dev/null | grep -c "^[a-f0-9]* feat:" 2>/dev/null || true)
FEAT_COUNT=${FEAT_COUNT:-0}

if [ "$FEAT_COUNT" -ge 5 ]; then
    if [ ! -f "TESTED.md" ]; then
        echo ""
        echo "⛔ BLOCKED: $FEAT_COUNT features committed but TESTED.md does not exist."
        echo "   HARD STOP 5 requires Playwright testing after each feature."
        echo "   Create TESTED.md with test results before committing more features."
        echo ""
        BLOCKED=1
    fi
elif [ "$FEAT_COUNT" -ge 3 ]; then
    if [ ! -f "TESTED.md" ]; then
        echo ""
        echo "⚠️  WARNING: $FEAT_COUNT features committed but no TESTED.md yet."
        echo "   HARD STOP 5: Test with Playwright and log results in TESTED.md."
        echo "   At 5 features, this becomes a BLOCK."
        echo ""
    fi
fi

# ============================================
# CHECK 4: PROGRESS.md checkpoint enforcement
# ============================================
# After 6+ feat: commits, BLOCK if no PROGRESS.md
if [ "$FEAT_COUNT" -ge 6 ]; then
    if [ ! -f "PROGRESS.md" ]; then
        echo ""
        echo "⛔ BLOCKED: $FEAT_COUNT features committed but PROGRESS.md does not exist."
        echo "   HARD STOP 6 requires PROGRESS.md after features #3, #6, #9, #12, #15."
        echo "   Run git log, update TASKS.md from facts, write PROGRESS.md."
        echo ""
        BLOCKED=1
    fi
elif [ "$FEAT_COUNT" -ge 3 ]; then
    if [ ! -f "PROGRESS.md" ]; then
        echo ""
        echo "⚠️  WARNING: $FEAT_COUNT features committed but no PROGRESS.md yet."
        echo "   HARD STOP 6: Create PROGRESS.md before feature #6."
        echo ""
    fi
fi

# ============================================
# CHECK 5: No secrets in committed files
# ============================================
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ]; then
        # Check for common secret patterns
        if grep -qE '(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36})' "$file" 2>/dev/null; then
            echo "⛔ BLOCKED: $file appears to contain an API key or secret. Remove it before committing."
            BLOCKED=1
        fi
    fi
done

# ============================================
# CHECK 6: No .env files committed
# ============================================
for file in $(git diff --cached --name-only); do
    if echo "$file" | grep -qE '\.env(\.local|\.production)?$'; then
        echo "⛔ BLOCKED: $file is an environment file. Add it to .gitignore."
        BLOCKED=1
    fi
done

if [ "$BLOCKED" -eq 1 ]; then
    echo ""
    echo "Commit blocked. Fix the issues above and try again."
    exit 1
fi

exit 0
